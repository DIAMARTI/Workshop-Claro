<h1>OpenShift Dia 4</h1>

<p>
<strong>Meta:</strong>
<br>Conocer el flujo de trabajo de openshift
</p>
<p>
<strong>Objetivos:</strong>
<br>- Automatizar el despliegue de aplicaciones con openshift
</p>
<p>
<strong>Secciones:</strong>
<br>- Gesti√≥n aplicaciones
</p>
<p>
<strong>Laboratorios:</strong>
<br><strong>-Explorando Templates</strong>
<br><strong>-Despliegue de middleware con contenido desde un git</strong>
<br><strong>-Despliegue de middleware con aplicaciones incluidas</strong>
<br><strong>-Despliegue de aplicaciones en cluster</strong>


</p>

<strong>Requisitos:</strong>
<br><strong>- Satellite</strong>
<br><strong>- RHEL client</strong>

<h3><br><strong>## Explorando templates</strong></h3>

<p align="left"><img src="https://github.com/workshopopennova/workshopclaro/raw/main/images/os023.png?raw=true?raw=true"></p>

Los templates permiten desplegar aplicaciones de forma rapida a traves del uso de parametros predefinidos, para ello primero nos logueamos al proyecto database0X y listamos los templates disponibles en la infraestrutura que coincidan con mariadb

<br>`# oc project database08`
<br>`# oc get template -n openshift | grep mariadb`

Para el primer ejemplo exploramos el template de mariadb que no es persistente por default
<br>`# oc describe template -n openshift mariadb-ephemeral`

Tambien podemos exportar el template a un archivo de texto que facilite su revision
<br>`# oc get template -n openshift mariadb-ephemeral -o yaml > template01.yaml`

Exploramos el template y sus variables, al menos revisemos las variables mas importan,tes, siendo estas
<br>MYSQL_USER
<br>MYSQL_PASSWORD
<br>MYSQL_DATABASE
<br>DATABASE_SERVICE_NAME

Con las variables identificadas, podemos crear un despliegue con el comando
<br>`# oc new-app --template=mariadb-ephemeral --param=MYSQL_USER=admin --param=MYSQL_PASSWORD=redhat --param=MYSQL_DATABASE=mariadb --param=DATABASE_SERVICE_NAME=mariadb`

En caso de no tener errores publicamos la aplicacion con
<br>`# oc expose service/mariadb`

Una vez finalizado el despliegue, examinamos los pods
<br>`# oc get pods`

Hacemos una sesion al pod que no sea deploy o build
<br>`# oc rsh <pod>`

Hacemos algunas consultas mysql
<br>`mysql -u root`
<br>`show databases;`
<br>`exit`
<br>`exit`

Borramos el despliegue actual con los comandos
<br>`# oc delete all --all`
<br>`# oc delete secret mariadb`

Si volvemos a explorar el template, notamos que la imagen de mariadb esta basada en RHEL8, pero podemos cambiarla a una basada en RHEL7
<br>`# oc new-app --template=mariadb-ephemeral --param=MYSQL_USER=admin --param=MYSQL_PASSWORD=redhat --param=MYSQL_DATABASE=mariadb --param=DATABASE_SERVICE_NAME=mariadb --param=MARIADB_VERSION=10.3-el7`

Examinamos el despliegue y recuperamos los recursos con
<br>`# oc delete all --all`
<br>`# oc delete secret mariadb`

<h3><br><strong>## Laboratorio 01</strong></h3>
<br> - Exporte el template de mariadb-ephemeral en un archivo .yaml el cual examinara para identificar las variables
<br> - Despliegue el template de mariadb-ephemeral en su proyecto database0X
<br> - Recuepere los recursos con los comandos # oc delete all --all # oc delete secret mariadb
<br> - Despliegue el template de mariadb-ephemeral en su proyecto database0X tomando como imagen base el sistema RHEL7
<br> - Recuepere los recursos con los comandos # oc delete all --all # oc delete secret mariadb

<h3><br><strong>## Almacenamiento persistente</strong></h3>

<p align="left"><img src="https://github.com/workshopopennova/workshopclaro/raw/main/images/os023.png?raw=true?raw=true"></p>

Para desplegar aplicaciones con la opcion de almacenamiento persistente, primero debemos contar con un recurso de almacenamiento compartido, en este caso podemos examinar los recursos NFS remotos disponibles para el alumno0X, cada alumno tiene recursos NFS remotos desde el pvX1 hasta el pvX9, en este ejemplo crearemos el recurso pvX1

<br>`# sudo mkdir /tmp/pv81`
<br>`# sudo mount -o,ro 192.168.10.130:/nfs/pv81 /tmp/pv81`
<br>`# sudo df -h`

Ahora que validamos que si contamos con acceso NFS al recurso pvX1 podemos crear un archivo que permita configurar un PV (recuerde cambiar los parametros unicos)

<br>`# vi pv81.yaml`

```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv81
spec:
  capacity:
    storage: 100Mi
  accessModes:
  - ReadWriteMany
  nfs:
    path: /nfs/pv81
    server: 192.168.10.130


```
<br>`apiVersion: v1`
<br>`kind: PersistentVolume`
<br>`metadata:`
<br>`  name: pv81`
<br>`spec:`
<br>`  capacity:`
<br>`    storage: 100Mi`
<br>`  accessModes:`
<br>`  - ReadWriteMany`
<br>`  nfs:`
<br>`    path: /nfs/pv81`
<br>`    server: 192.168.10.130`


<br>`# oc project database08`
<br>`# oc get template -n openshift | grep mariadb`

Para el primer ejemplo exploramos el template de mariadb que no es persistente por default
<br>`# oc describe template -n openshift mariadb-ephemeral`

Tambien podemos exportar el template a un archivo de texto que facilite su revision
<br>`# oc get template -n openshift mariadb-ephemeral -o yaml > template01.yaml`

Exploramos el template y sus variables, al menos revisemos las variables mas importan,tes, siendo estas
<br>MYSQL_USER
<br>MYSQL_PASSWORD
<br>MYSQL_DATABASE
<br>DATABASE_SERVICE_NAME

Con las variables identificadas, podemos crear un despliegue con el comando
<br>`# oc new-app --template=mariadb-ephemeral --param=MYSQL_USER=admin --param=MYSQL_PASSWORD=redhat --param=MYSQL_DATABASE=mariadb --param=DATABASE_SERVICE_NAME=mariadb`

En caso de no tener errores publicamos la aplicacion con
<br>`# oc expose service/mariadb`

Una vez finalizado el despliegue, examinamos los pods
<br>`# oc get pods`

Hacemos una sesion al pod que no sea deploy o build
<br>`# oc rsh <pod>`



<br>
<br>
<br>
<h3><a href="os">Volver</a></h3>
